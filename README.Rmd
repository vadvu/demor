---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE, 
  message = FALSE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# demor

<!-- badges: start -->
<!-- badges: end -->

The goal of `demor` is to provide you with:    
1. the most basic functions for demographic analysis    
2. some data    

## Installation

You can install the development version of demor from [GitHub](https://github.com/) with:

``` r

# install.packages("devtools")
devtools::install_github("vadvu/demor")

```

## Get ROSBRIS data

For getting data from [RosBris](http://demogr.nes.ru/index.php/ru/demogr_indicat/data) there is function `get_rosbris()` that can download 
data on mortality/fertility by 1/5-year age groups from 1989 to the last available year (in 2023 its 2022).    
Worth noting: downloading and preparing the final file can get some time.    
In the chunk below mortality data for 5-age groups with population in "long" format is loading. For more function description use `?get_rosbris` 

```{r}
library(demor)

dbm <- get_rosbris(
  #mortality data
  type = "m",
  #what age group download
  age =  5,
  #to get "long" data
  initial = F,
  #last available year (the name of the downloading file contains years, so for the downloading the last year is required)
  lastyear = 2022
)
```

Lets see data for Russia in 2010 for males and for total population (both urban and rural)

```{r}
dbm[dbm$year==2010 & dbm$code==1100 & dbm$sex=="m" & dbm$territory=="t",]
```


## Life-table and additional function for mortality

Now one can create life-table based on gotten data for 2010-Russia using `LT()`.    
Note, nax for year 0 is modeled as in:    
Andreev, E. M., & Kingkade, W. W. (2015). Average age at death in infancy and infant mortality level: Reconsidering the Coale-Demeny formulas at current levels of low mortality. Demographic Research, 33, 363-390.

```{r}
rus2010 <- dbm[dbm$year==2010 & dbm$code==1100 & dbm$sex=="m" & dbm$territory=="t",]

LT(
  age = rus2010$age, 
  sex = "m", 
  #age specific mortality rates
  mx = rus2010$mx)
```

Also one can do simple decomposition between 2 populations. Lets use Russia-2000 as base population and Russia-2010 as compared population

```{r}
rus2010 <- dbm[dbm$year==2010 & dbm$code==1100 & dbm$sex=="m" & dbm$territory=="t",]
rus2000 <- dbm[dbm$year==2000 & dbm$code==1100 & dbm$sex=="m" & dbm$territory=="t",]

dec <- decomp(mx1 = rus2000$mx, 
              mx2 = rus2010$mx, 
              sex = "m", 
              age = rus2000$age, 
              method = "andreev")
dec
```

Than let us plot the result of `decomp`. 

```{r}
barplot(height=dec$ex12, 
        names=dec$age,
        xlab="Age-groups", 
        ylab="Ð¡ontribution to the e0 difference")
```


Also in the `demor` there is `leecart()` function that provides users with basic Lee-Carter model (IT IS IN DEMO NOW!) for mortality forecasting

```{r}
leecart_forecast <- leecart(data = dbm[dbm$code==1100 & dbm$territory=="t" & dbm$sex=="m" & dbm$year %in% 2004:2019,c("year", "age", "mx")], 
                            n = 2
                            )
head(leecart_forecast)
```


AThere is `asdt()` function (also IT IS IN DEMO NOW!) that calculates associated single decrement life table (ASDT) for causes of death (cause-deleted life table). 
In other words, by this function one can answer the question "what will be the life expectancy if there is no mortality from cause i ?"   
For the example in the `demor` data (as it is easy to guess, taken from 
Andreev & Shkolnikov [spreadsheet](https://www.demogr.mpg.de/en/publications_databases_6118/publications_1904/mpidr_technical_reports/an_excel_spreadsheet_for_the_decomposition_of_a_difference_between_two_values_of_an_aggregate_demographic_4591)) 
on  mortality of US men in 2002 by some causes is added. Let me show what would be ex if there is no deaths from neoplasm (i)

```{r}
data("asdtex")

asdt(age = asdtex$age, 
     sex = "m",
     m_all = asdtex$all, 
     m_i = asdtex$neoplasms, 
     full = F, 
     method = "chiang1968")[,c("age", "ex", "ex_without_i")]
```

## Some fertility

For the analysis of fertility in the `demor` there are only a few (1...) functions, due to the author's preference for mortality analysis...    
Lets get basic fertility data (asFR) from [RosBris](http://demogr.nes.ru/index.php/ru/demogr_indicat/data) using `get_rosbris()`

```{r}
dbf <- get_rosbris(
  #fertility data
  type = "f",
  #what age group download
  age =  5,
  #to get "long" data
  initial = F,
  #last available year
  lastyear = 2022
)
```

For the example Russia-2010 is gotten

```{r}
rus2010f <- dbf[dbf$year==2010 & dbf$code==1100 & dbf$territory=="t",]
rus2010f
```


Now one can compute TFR

```{r}
tfr(
  #asFR
  rus2010f$fx,
  #age interval
  age.int = 5
    )
```


## Some other functions

Also in the `demor` there are some additional functions.    
One of them is `plot_pyr` that plots population pyramid using [ggplot2](https://github.com/tidyverse/ggplot2)   
Lets create population pyramid using midyear population from Rosbris mortality data. We already have data in `dbm`. 

```{r}
plot_pyr(
  popm = dbm[dbm$year==2010 & dbm$code==1100 & dbm$territory=="t" & dbm$sex=="m",]$N,
  popf = dbm[dbm$year==2010 & dbm$code==1100 & dbm$territory=="t" & dbm$sex=="f",]$N, 
  ages = dbm[dbm$year==2010 & dbm$code==1100 & dbm$territory=="t" & dbm$sex=="f",]$age)
```


Also one can designed plot using `ggplot2` functions

```{r}
library(ggplot2)
plot <- 
  plot_pyr(
  popm = dbm[dbm$year==2010 & dbm$code==1100 & dbm$territory=="t" & dbm$sex=="m",]$N,
  popf = dbm[dbm$year==2010 & dbm$code==1100 & dbm$territory=="t" & dbm$sex=="f",]$N, 
  ages = dbm[dbm$year==2010 & dbm$code==1100 & dbm$territory=="t" & dbm$sex=="f",]$age)

plot + 
  labs(y = "My y", x = "Age")+
  theme_minimal()
```








